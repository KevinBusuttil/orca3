# Orca3 Base Controller and Localization

Orca3 is designed for the [BlueRobotics BlueROV2](https://bluerobotics.com/store/rov/bluerov2/),
a simple but powerful ROV (Remotely Operated Vehicle) with two vertical thrusters and 
four vectored horizontal thrusters. See [orca_gazebo](../orca_gazebo) for more information.

Perhaps the biggest challenge in underwater robotics is localization:
* radio (e.g., GPS) doesn't work underwater
* you generally can't see the seafloor
* sonar is useful, but it is typically big, expensive and power-hungry
([although this is improving](https://bluerobotics.com/product-category/sensors-sonars-cameras/sonar/))
* inexpensive IMUs aren't good for more than a few meters, and the good ones are big and expensive 

As currently written, Orca3 localizes using two sensors:
* a barometer provides a fairly accurate depth
* a forward-facing camera is used with ArUco markers in the environment to generate poses from a
known map. Map generation and localization is provided by the [fiducial_vlam](https://github.com/ptrmu/fiducial_vlam)
package.

Orca3 operation looks like this:
* add ArUco markers to the environment
* localize against a marker to get an initial pose
* run a mission that involves occasional views of ArUco markers. Between markers the AUV
will run dead-reckoning with a known depth.

## BaseController

The `BaseController` node does the following:
* subscribe to `/cmd_vel` from the Nav2 system
* integrate the desired velocity to generate odometry
* publishe odometry on `/odom`, and broadcast the odom->base transform
* subscribe to `/depth` from the barometer and run a PID controller to hold depth at the desired value
* calculate the thrust forces (see below) and publish `/thrust` messages for the Gazebo simulation

The thrust force calculations consider these factors:
* expected drag at the desired velocity. I've estimated the drag of the BlueROV2 frame, but this is very rough,
and each actual AUV will have different drag properties.
* the expected vertical force required to hover at the desired depth when velocity is 0
* the actual depth provided by the barometer, run through a PID controller

Note that the AUV won't instantly achieve the desired velocity, so the AUV will tend to undershoot
during acceleration and overshoot during deceleration. In addition, abrupt changes in thrust may
cause the AUV frame to pitch or roll. To minimize these problems the Nav2 plugins limit acceleration.

### Parameters

| Parameter | Type | Default | Notes |
|---|---|---|---|
| map_frame_id | string | map | Map frame id |
| odom_frame_id | string | odom | Odom frame id |
| base_frame_id | string | base_link | Base frame id |
| thruster_xy_limit | double | 0.5 | Limit the x and y effort in the vectored horizontal thrusters to provide enough pwm range for yaw motion |
| thruster_accel_limit | double | 1.0 | Limit overall thruster effort, set to < 1.0 to reduce overall thrust |
| pid_enabled | bool | true | Turn the depth PID controller on/off |
| pid_z_kp | double | 0.5 | Kp |
| pid_z_ki | double | 0 | Ki |
| pid_z_kd | double | 0 | Kd |
| pid_z_i_max | double | 0.1 | Windup prevention: max acceleration from Ki term (m/s^2) |

## FiducialLocalizer

The `FiducialLocalizer` node does the following:
* subscribe to `/fiducial_observations`, a list of marker observations, and `/forward_camera/camera_pose`,
the pose of the camera generated by solvePnP or GTSAM
* reject poses generated by markers that are too far away. This avoids unstable solutions.
* calculate the map->base_link transform 
* publish the map->odom transform

No transforms are published until a marker is observed. After the first observation transforms are
published at the target rate with updated timestamps, even if they are old.

### Parameters

| Parameter | Type | Default | Notes |
|---|---|---|---|
| map_frame_id | string | map | Map frame id |
| odom_frame_id | string | odom | Odom frame id |
| camera_frame_id | string | camera_frame | Camera frame id |
| publish_rate | int | 20 | How often to publish transforms, Hz |
| wait_for_transform_ms | int | 500 | How long to wait for the odom->base transform, ms |
| transform_expiration_ms | int | 1000 | How far ahead to post-date the map->odom transform, ms |
| good_pose_distance | double | 2.0 | Maximum distance for a good marker observation, m |

## DepthNode

The `DepthNode` subscribes to `/barometer` messages, converts pressure to depth, and publishes
`/depth` messages. TODO(clyde): calibrate using ArUco markers

### Parameters

| Parameter | Type | Default | Notes |
|---|---|---|---|
| map_frame_id | string | map | Map frame id |
| z_variance | double | 0.0004 | Variance, m |
| stamp_msgs_with_current_time | bool | false | Use now() vs Barometer.header.stamp |
